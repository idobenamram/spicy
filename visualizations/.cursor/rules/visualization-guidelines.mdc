---
alwaysApply: true
---

### Visualization Guidelines (Bevy 0.17)

These rules guide all visualizations under `visualizations/`. The goal is to build clear, step-based animations of algorithms used in electronic circuit simulation (SPICE-like), using Bevy 0.17.

### Tech and versioning
- **Engine**: Bevy 0.17. Follow 0.17 APIs (`add_systems(Update, ...)`, schedules, `ButtonInput`, `Camera2d`, etc.).
- **UI**: `bevy_egui` 0.33 (and `egui_extras` 0.33 when needed).
- **Shapes**: Prefer sprites/quads; use `bevy_prototype_lyon` 0.12 behind a feature flag (`lyon`) for vector shapes.
- **Style**: Minimal dependencies, deterministic behavior, readable code with descriptive names.

### Interaction model (keyboard-first)
- **Primary controls** (consistent across projects):
  - Space: play/pause
  - Right Arrow: next step
  - Left Arrow: previous step
  - Up/Down: adjust playback speed
  - C: toggle code panel
- Prefer keyboard over camera. Use a fixed 2D camera. Avoid mouse pan/zoom unless absolutely necessary for readability; if used, keep it minimal and optional.

### Step recording and playback
- Use `visualizations/btf_viz/src/code/recorder.rs` to produce traces from algorithms.
  - `set_initial(name, &value)`: capture initial state blobs (grids, arrays, parameters).
  - `push_array_step(line, name, index, &value)`: record an array element update at source `line`.
  - `push_number_step(line, name, &value)`: record a scalar update at source `line`.
  - `push_step(line)`: mark a logical step boundary (advances the animation timeline).
  - `flush()`: write JSON `{ initial, steps }` to disk.
- Playback loads this JSON into a `Trace` resource. Systems read `Trace` to update the visual `State` and to highlight code.
- Keep steps granular and meaningful; prefer many small updates with explicit `push_step` boundaries.

### 3Blue1Brown-inspired motion and look
- **Motion**: smooth, eased transitions (e.g., ease in-out cubic), short but readable durations. Avoid abrupt jumps where possible.
- **Composition**: emphasize relationships with brackets, arrows, and subtle highlights; de-emphasize background with low-contrast fills.
- **Palette**: dark background, high-contrast white for key elements, accent colors for highlights; use alpha for depth, avoid visual noise.